name: Test Nodes with Karing

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      trigger_collection:
        description: 'æ˜¯å¦ç”±æ”¶é›†å·¥ä½œæµè§¦å‘'
        required: false
        default: false
        type: boolean
      collection_commit:
        description: 'æ”¶é›†å·¥ä½œæµçš„æäº¤SHA'
        required: false
        default: ''
        type: string
      total_nodes:
        description: 'æ”¶é›†åˆ°çš„æ€»èŠ‚ç‚¹æ•°'
        required: false
        default: '0'
        type: string

  push:
    paths:
      - 'result/nodetotal.txt'
    branches: [main]

jobs:
  test-nodes:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # 1.5å°æ—¶è¶…æ—¶
    permissions:
      contents: write

    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        persist-credentials: true

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Cloudflare WARP
      run: |
        # æ·»åŠ  Cloudflare GPG å¯†é’¥
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg

        # æ·»åŠ  Cloudflare ä»“åº“
        echo 'deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ jammy main' | sudo tee /etc/apt/sources.list.d/cloudflare-client.list

        # æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£… warp-cli
        sudo apt-get update
        sudo apt-get install -y cloudflare-warp

    - name: Connect to Cloudflare WARP
      run: |
        # å¯åŠ¨ WARP æœåŠ¡
        sudo systemctl enable --now warp-svc

        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 10

        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        sudo systemctl status warp-svc --no-pager || true

        # æ³¨å†Œ WARPï¼ˆä½¿ç”¨åŒ¿åæ¨¡å¼ï¼‰
        warp-cli --accept-tos registration new

        # è®¾ç½® WARP ä»£ç†æ¨¡å¼ï¼ˆå…³é”®æ­¥éª¤ï¼‰
        echo "è®¾ç½®WARPä¸ºä»£ç†æ¨¡å¼..."
        warp-cli --accept-tos mode proxy 2>/dev/null || warp-cli --accept-tos set-mode proxy 2>/dev/null || true

        # è®¾ç½® SOCKS5 ä»£ç†ç«¯å£
        echo "è®¾ç½®SOCKS5ä»£ç†ç«¯å£40000..."
        warp-cli --accept-tos proxy port 40000 2>/dev/null || warp-cli --accept-tos set-proxy-port 40000 2>/dev/null || true

        # è¿æ¥ WARP
        warp-cli --accept-tos connect

        # ç­‰å¾…è¿æ¥å®Œå…¨å»ºç«‹
        echo "â³ ç­‰å¾…WARPè¿æ¥å®Œå…¨å»ºç«‹..."
        sleep 20

        # éªŒè¯è¿æ¥çŠ¶æ€
        echo "ğŸ” æ£€æŸ¥WARPè¿æ¥çŠ¶æ€..."
        warp-cli --accept-tos status

        # éªŒè¯SOCKS5ä»£ç†ç«¯å£
        echo "ğŸ” æ£€æŸ¥SOCKS5ä»£ç†ç«¯å£40000..."
        if sudo ss -tlnp | grep -q ":40000"; then
          echo "âœ“ SOCKS5ä»£ç†ç«¯å£40000å·²ç›‘å¬"
        else
          echo "âš ï¸ SOCKS5ä»£ç†ç«¯å£40000æœªç›‘å¬"
        fi

        # éªŒè¯IPå˜æ›´
        echo "ğŸŒ éªŒè¯IPåœ°å€å˜æ›´..."
        current_ip=$(curl -s --max-time 10 ipinfo.io/ip || echo "æ£€æµ‹å¤±è´¥")
        echo "å½“å‰IP: $current_ip"

        # è·å– WARP ä»£ç†ç«¯å£ï¼ˆé€šå¸¸æ˜¯ 40000ï¼‰
        echo "âœ… WARP ä»£ç†å·²å¯ç”¨ï¼ŒSOCKS5 ç«¯å£: 40000"

    - name: Create Karing latency test script
      run: |
        echo "åˆ›å»ºKaringå»¶è¿Ÿæµ‹è¯•è„šæœ¬..."
        cat > karing_latency_test.py << 'EOF'
        #!/usr/bin/env python3
        # -*- coding: utf-8 -*-
        """
        Karingå»¶è¿Ÿæµ‹è¯•å·¥å…·
        åŸºäºKaringçš„å»¶è¿Ÿæµ‹è¯•é€»è¾‘å®ç°
        """

        import asyncio
        import aiohttp
        import json
        import time
        import sys
        from pathlib import Path
        from typing import List, Dict, Optional
        import urllib.parse

        class KaringLatencyTester:
            """Karingå»¶è¿Ÿæµ‹è¯•å™¨"""

            def __init__(self):
                self.timeout = aiohttp.ClientTimeout(total=10)
                self.test_urls = [
                    "https://www.google.com/generate_204",
                    "https://www.cloudflare.com/",
                    "https://www.apple.com/",
                    "https://www.microsoft.com/",
                    "https://www.baidu.com/",
                    "https://www.bing.com/"
                ]

            async def test_node_latency(self, node_config: str, proxy: Optional[str] = None) -> Dict:
                """æµ‹è¯•å•ä¸ªèŠ‚ç‚¹çš„å»¶è¿Ÿ"""
                try:
                    # è§£æèŠ‚ç‚¹é…ç½®
                    if node_config.startswith("vmess://"):
                        # è§£ævmessé“¾æ¥
                        import base64
                        vmess_data = json.loads(base64.b64decode(node_config[8:]).decode("utf-8"))
                        server = vmess_data.get("add", "")
                        port = vmess_data.get("port", 443)
                        protocol = "vmess"
                    elif node_config.startswith("vless://"):
                        # è§£ævlessé“¾æ¥
                        parsed = urllib.parse.urlparse(node_config)
                        server = parsed.hostname
                        port = parsed.port or 443
                        protocol = "vless"
                    elif node_config.startswith("ss://"):
                        # è§£æssé“¾æ¥
                        import base64
                        ss_data = base64.b64decode(node_config[5:].split("@")[0]).decode("utf-8")
                        server = node_config.split("@")[1].split(":")[0]
                        port = int(node_config.split(":")[-1])
                        protocol = "ss"
                    else:
                        # å…¶ä»–åè®®è·³è¿‡
                        return {"config": node_config, "latency": -1, "error": "Unsupported protocol"}

                    # æ„å»ºä»£ç†URL
                    proxy_url = None
                    if proxy:
                        proxy_url = f"socks5://{proxy}"

                    # æµ‹è¯•å»¶è¿Ÿ
                    latencies = []
                    for test_url in self.test_urls[:2]:  # åªæµ‹è¯•å‰2ä¸ªURL
                        try:
                            start_time = time.time()
                            async with aiohttp.ClientSession(timeout=self.timeout, connector=aiohttp.TCPConnector(limit=1)) as session:
                                async with session.get(test_url, proxy=proxy_url) as response:
                                    if response.status == 200 or response.status == 204:
                                        latency = int((time.time() - start_time) * 1000)  # æ¯«ç§’
                                        latencies.append(latency)
                        except Exception as e:
                            continue

                    if latencies:
                        avg_latency = sum(latencies) // len(latencies)
                        return {
                            "config": node_config,
                            "latency": avg_latency,
                            "protocol": protocol,
                            "server": server,
                            "port": port
                        }
                    else:
                        return {"config": node_config, "latency": -1, "error": "Connection failed"}

                except Exception as e:
                    return {"config": node_config, "latency": -1, "error": str(e)}

            async def test_nodes_batch(self, node_configs: List[str], proxy: Optional[str] = None, max_concurrent: int = 10) -> List[Dict]:
                """æ‰¹é‡æµ‹è¯•èŠ‚ç‚¹å»¶è¿Ÿ"""
                semaphore = asyncio.Semaphore(max_concurrent)
                results = []

                async def test_with_semaphore(config):
                    async with semaphore:
                        result = await self.test_node_latency(config, proxy)
                        results.append(result)
                        print(f"âœ“ æµ‹è¯•å®Œæˆ: {result.get('server', 'Unknown')} - {result.get('latency', -1)}ms")

                tasks = [test_with_semaphore(config) for config in node_configs]
                await asyncio.gather(*tasks)

                return results

        async def main():
            """ä¸»å‡½æ•°"""
            if len(sys.argv) < 3:
                print("ç”¨æ³•: python karing_latency_test.py <è¾“å…¥æ–‡ä»¶> <è¾“å‡ºæ–‡ä»¶>")
                sys.exit(1)

            input_file = sys.argv[1]
            output_file = sys.argv[2]

            # è¯»å–èŠ‚ç‚¹é…ç½®
            with open(input_file, "r", encoding="utf-8") as f:
                node_configs = [line.strip() for line in f if line.strip()]

            print(f"ğŸ“‹ è¯»å–åˆ° {len(node_configs)} ä¸ªèŠ‚ç‚¹é…ç½®")

            # åˆå§‹åŒ–æµ‹è¯•å™¨
            tester = KaringLatencyTester()

            # æµ‹è¯•å»¶è¿Ÿ
            print("ğŸš€ å¼€å§‹å»¶è¿Ÿæµ‹è¯•...")
            results = await tester.test_nodes_batch(node_configs, max_concurrent=8)

            # è¿‡æ»¤æœ‰æ•ˆèŠ‚ç‚¹ (å»¶è¿Ÿ < 3000ms)
            valid_results = [r for r in results if r.get("latency", -1) > 0 and r.get("latency", -1) < 3000]

            # æŒ‰å»¶è¿Ÿæ’åº
            valid_results.sort(key=lambda x: x.get("latency", 9999))

            print(f"âœ… æ‰¾åˆ° {len(valid_results)} ä¸ªæœ‰æ•ˆèŠ‚ç‚¹")

            # ä¿å­˜ç»“æœ
            with open(output_file, "w", encoding="utf-8") as f:
                for result in valid_results:
                    f.write(result["config"] + "\n")

            print(f"ğŸ’¾ ç»“æœå·²ä¿å­˜åˆ° {output_file}")

        if __name__ == "__main__":
            asyncio.run(main())
        EOF

        chmod +x karing_latency_test.py
        echo "âœ… Karingå»¶è¿Ÿæµ‹è¯•è„šæœ¬åˆ›å»ºå®Œæˆ"

    - name: Test nodes with Karing latency test
      id: tester
      run: |
        echo "ğŸš€ å¼€å§‹ä½¿ç”¨Karingå»¶è¿Ÿæµ‹è¯• - 6å°æ—¶å®šæ—¶ç­–ç•¥"
        echo "ğŸ“Š Configuration:"
        echo "  â° Schedule: Every 6 hours (00:00, 06:00, 12:00, 18:00 Beijing Time)"
        echo "  ğŸ”§ Phase 1: Latency test only (concurrent=8, timeout=10s)"
        echo "  ğŸ¯ Filter: Latency < 3000ms"
        echo "  ğŸ“ Strategy: Based on Karing latency testing logic"

        # æ£€æŸ¥èŠ‚ç‚¹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
        if [ ! -f result/nodetotal.txt ] || [ ! -s result/nodetotal.txt ]; then
          echo "âŒ No valid nodes file found (result/nodetotal.txt is missing or empty)"
          echo "âš ï¸ Skipping node testing as there are no nodes to test"
          exit 0
        fi

        # è·å–èŠ‚ç‚¹æ•°
        total_nodes=$(wc -l < result/nodetotal.txt)
        echo "ğŸ“ˆ Total nodes to test: $total_nodes"

        # ä½¿ç”¨Karingå»¶è¿Ÿæµ‹è¯•è„šæœ¬
        set -e
        echo "ğŸ”„ Starting Python test script with progress indicators..."
        echo "ğŸ“ Processing nodes with Karing latency testing..."
        echo "ğŸ”— Command: python3 karing_latency_test.py result/nodetotal.txt result/karing.txt"
        echo "â³ Starting test with progress monitoring..."
        echo ""
        echo "âš¡ å¼€å§‹æ‰§è¡ŒKaringå»¶è¿Ÿæµ‹è¯•..."
        python3 karing_latency_test.py result/nodetotal.txt result/karing.txt

        echo ""
        echo "ğŸ“Š Pythonè„šæœ¬æ‰§è¡Œå®Œæˆï¼"

        echo "Karingå»¶è¿Ÿæµ‹è¯•å®Œæˆ"
      continue-on-error: true

    - name: Check for changes
      id: changes
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶çŠ¶æ€..."

        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
        if [ -f result/karing.txt ] && [ -s result/karing.txt ]; then
          echo "result/karing.txt å­˜åœ¨ä¸”ä¸ä¸ºç©º"
          node_count=$(wc -l < result/karing.txt)
          echo "æœ‰æ•ˆèŠ‚ç‚¹æ•°: $node_count"
          echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -5 result/karing.txt || echo "æ— æ³•é¢„è§ˆ"
          file_valid=true
        else
          echo "âš ï¸ result/karing.txt ä¸å­˜åœ¨æˆ–ä¸ºç©º"
          file_valid=false
          node_count=0
        fi

        echo ""
        echo "Git çŠ¶æ€:"
        git status --short

        echo ""
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."

        # å¦‚æœæ–‡ä»¶æ— æ•ˆï¼Œç›´æ¥æ ‡è®°æ— å˜æ›´
        if [ "$file_valid" = false ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "âŒ æµ‹è¯•ç»“æœæ–‡ä»¶æ— æ•ˆï¼Œè·³è¿‡æäº¤"
          exit 0
        fi

        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´ï¼ˆåŒ…æ‹¬æ–°æ–‡ä»¶ï¼‰
        if git diff --quiet HEAD -- result/karing.txt 2>/dev/null; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°èŠ‚ç‚¹æ›´æ–°"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°èŠ‚ç‚¹æ›´æ–°"
          echo "å˜æ›´è¯¦æƒ…:"
          git diff HEAD -- result/karing.txt || echo "æ— æ³•æ˜¾ç¤ºå˜æ›´"
        fi

    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        echo "å¼€å§‹æäº¤å˜æ›´..."

        # é…ç½® git
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"

        # å…ˆæ‹‰å–æœ€æ–°ä»£ç é¿å…å†²çª
        echo "æ‹‰å–æœ€æ–°ä»£ç ..."
        git pull origin main --rebase || true

        # æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº
        echo "æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº..."
        git add result/karing.txt

        # æ£€æŸ¥æš‚å­˜åŒºçŠ¶æ€
        echo "æš‚å­˜åŒºçŠ¶æ€:"
        git status --short

        # è·å–èŠ‚ç‚¹æ•°é‡ç”¨äºæäº¤ä¿¡æ¯
        if [ -f result/karing.txt ]; then
          valid_count=$(wc -l < result/karing.txt)
        else
          valid_count=0
        fi

        if [ -f result/nodetotal.txt ]; then
          total_count=$(wc -l < result/nodetotal.txt)
        else
          total_count=0
        fi

        # ç”Ÿæˆè¯¦ç»†çš„æäº¤ä¿¡æ¯
        if [ ${total_count} -gt 0 ]; then
          pass_rate=$(echo "scale=1; ${valid_count} * 100 / ${total_count}" | bc -l)
          commit_msg="Karingå»¶è¿Ÿæµ‹è¯• - èŠ‚ç‚¹æ€»æ•°:${total_count} æœ‰æ•ˆèŠ‚ç‚¹:${valid_count} é€šè¿‡ç‡:${pass_rate}%"
        else
          commit_msg="Karingå»¶è¿Ÿæµ‹è¯• - èŠ‚ç‚¹æ€»æ•°:${total_count} æœ‰æ•ˆèŠ‚ç‚¹:${valid_count} é€šè¿‡ç‡:N/A"
        fi

        echo "æäº¤ä¿¡æ¯: $commit_msg"

        # æäº¤å˜æ›´
        git commit -m "$commit_msg"

        # æ£€æŸ¥æäº¤æ˜¯å¦æˆåŠŸ
        if [ $? -ne 0 ]; then
          echo "âŒ æäº¤å¤±è´¥"
          exit 1
        fi

        # å°è¯•æ¨é€ï¼Œå¦‚æœæœ‰å†²çªåˆ™é‡è¯•
        echo "å¼€å§‹æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
        for i in {1..3}; do
          if git push origin main; then
            echo "âœ… æˆåŠŸæ¨é€åˆ°è¿œç¨‹ä»“åº“"
            break
          elif [ $i -eq 3 ]; then
            echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²é‡è¯•3æ¬¡"
            exit 1
          else
            echo "âš ï¸ ç¬¬$iæ¬¡æ¨é€å¤±è´¥ï¼Œç­‰å¾…5ç§’åé‡è¯•..."
            sleep 5
          fi
        done

        echo "Karingå»¶è¿Ÿæµ‹è¯•ç»“æœå·²æäº¤å¹¶æ¨é€åˆ°ä»“åº“"

    - name: Create summary
      if: always()
      run: |
        echo "## Karingå»¶è¿Ÿæµ‹è¯•æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "- **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

        # åˆ¤æ–­è§¦å‘æ¥æº
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "- **è§¦å‘æ–¹å¼**: âœ‹ æ‰‹åŠ¨è§¦å‘" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.trigger_collection }}" == "true" ]; then
            echo "- **æ”¶é›†æäº¤**: ${{ github.event.inputs.collection_commit }}" >> $GITHUB_STEP_SUMMARY
            echo "- **æ€»èŠ‚ç‚¹æ•°**: ${{ github.event.inputs.total_nodes }}" >> $GITHUB_STEP_SUMMARY
          fi
        elif [ "${{ github.event_name }}" == "push" ]; then
          echo "- **è§¦å‘æ–¹å¼**: ğŸ“ æ–‡ä»¶å˜æ›´è§¦å‘" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æäº¤**: ${{ github.event.after }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å˜æ›´æ–‡ä»¶**: result/nodetotal.txt" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
          echo "- **æ›´æ–°çŠ¶æ€**: âœ… æˆåŠŸæ›´æ–°" >> $GITHUB_STEP_SUMMARY
          if [ -f result/karing.txt ]; then
            valid_count=$(wc -l < result/karing.txt)
            echo "- **æœ‰æ•ˆèŠ‚ç‚¹æ•°**: $valid_count" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f result/nodetotal.txt ]; then
            total_count=$(wc -l < result/nodetotal.txt)
            echo "- **åŸå§‹èŠ‚ç‚¹æ•°**: $total_count" >> $GITHUB_STEP_SUMMARY
            if [ -f result/karing.txt ]; then
              success_rate=$(echo "scale=1; $valid_count * 100 / $total_count" | bc)
              echo "- **æˆåŠŸç‡**: $success_rate%" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æµ‹è¯•ç­–ç•¥**:" >> $GITHUB_STEP_SUMMARY
          echo "- ä½¿ç”¨Karingå»¶è¿Ÿæµ‹è¯•é€»è¾‘è¿›è¡ŒèŠ‚ç‚¹è¿é€šæ€§æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- æµ‹è¯•å¤šä¸ªURLç«¯ç‚¹çš„å»¶è¿Ÿå¹¶å–å¹³å‡å€¼" >> $GITHUB_STEP_SUMMARY
          echo "- åªä¿ç•™å»¶è¿Ÿå°äº3000msçš„æœ‰æ•ˆèŠ‚ç‚¹" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **æ›´æ–°çŠ¶æ€**: â„¹ï¸ æ— æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ steps.tester.outcome }}" != "success" ]; then
          echo "- **æµ‹é€ŸçŠ¶æ€**: âš ï¸ æµ‹é€Ÿè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Karingå»¶è¿Ÿæµ‹è¯•å¤±è´¥"
        echo "è¯·æ£€æŸ¥æ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯"
        exit 1