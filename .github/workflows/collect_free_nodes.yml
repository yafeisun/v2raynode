name: Collect Free Nodes

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸‹åˆ3ç‚¹ (UTCæ—¶é—´7ç‚¹) è¿è¡Œ
    - cron: '0 7 * * *'
  
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰èŠ‚ç‚¹'
        required: false
        default: false
        type: boolean

jobs:
  update-nodes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TZ: Asia/Shanghai  # è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´ï¼Œè§£å†³æ–‡ç« é“¾æ¥åŒ¹é…é—®é¢˜
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        persist-credentials: true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r config/requirements.txt
        pip install pysocks  # æ”¯æŒ SOCKS5 ä»£ç†
        pip install playwright>=1.40.0
        playwright install chromium  # å®‰è£…Chromiumæµè§ˆå™¨
    
    - name: Install Cloudflare WARP
      run: |
        # æ·»åŠ  Cloudflare GPG å¯†é’¥
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg

        # æ·»åŠ  Cloudflare ä»“åº“
        echo 'deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ jammy main' | sudo tee /etc/apt/sources.list.d/cloudflare-client.list

        # æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£… warp-cli
        sudo apt-get update
        sudo apt-get install -y cloudflare-warp
    
    - name: Connect to Cloudflare WARP
      run: |
        # å¯åŠ¨ WARP æœåŠ¡
        sudo systemctl enable --now warp-svc

        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 10

        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        sudo systemctl status warp-svc --no-pager || true

        # æ³¨å†Œ WARPï¼ˆä½¿ç”¨åŒ¿åæ¨¡å¼ï¼‰
        sudo warp-cli --accept-tos registration new || true

        # è®¾ç½® WARP ä»£ç†æ¨¡å¼ï¼ˆå…³é”®æ­¥éª¤ï¼‰
        echo "è®¾ç½®WARPä¸ºä»£ç†æ¨¡å¼..."
        sudo warp-cli --accept-tos mode proxy 2>/dev/null || sudo warp-cli --accept-tos set-mode proxy 2>/dev/null || true

        # è®¾ç½® SOCKS5 ä»£ç†ç«¯å£
        echo "è®¾ç½®SOCKS5ä»£ç†ç«¯å£40000..."
        sudo warp-cli --accept-tos proxy port 40000 2>/dev/null || sudo warp-cli --accept-tos set-proxy-port 40000 2>/dev/null || true

        # è¿æ¥ WARP
        sudo warp-cli --accept-tos connect || true

        # ç­‰å¾…è¿æ¥å®Œå…¨å»ºç«‹
        echo "ç­‰å¾…WARPè¿æ¥å®Œå…¨å»ºç«‹..."
        for i in {1..30}; do
          STATUS=$(sudo warp-cli --accept-tos status 2>&1 | grep -o "Status update:.*" | head -1 || echo "")
          if echo "$STATUS" | grep -q "Success"; then
            echo "âœ“ WARPå·²è¿æ¥æˆåŠŸ ($i/30)"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "âš ï¸ WARPè¿æ¥è¶…æ—¶ï¼Œç»§ç»­æ‰§è¡Œ..."
          fi
          sleep 1
        done

        # éªŒè¯æœ€ç»ˆçŠ¶æ€
        echo "WARPæœ€ç»ˆçŠ¶æ€ï¼š"
        sudo warp-cli --accept-tos status || true

        # ç­‰å¾…SOCKS5ä»£ç†ç«¯å£å¯åŠ¨
        echo "ç­‰å¾…SOCKS5ä»£ç†ç«¯å£40000å¯åŠ¨..."
        sleep 10

        # æ£€æŸ¥SOCKS5ä»£ç†ç«¯å£
        if sudo ss -tlnp | grep -q ":40000"; then
          echo "âœ“ SOCKS5ä»£ç†ç«¯å£40000å·²ç›‘å¬"
        else
          echo "âš ï¸ SOCKS5ä»£ç†ç«¯å£40000æœªç›‘å¬ï¼Œç»§ç»­æ‰§è¡Œ..."
        fi

        echo "WARPä»£ç†å·²è®¾ç½®ï¼ŒSOCKS5 ç«¯å£: 40000"
    
    - name: Run node collector
      id: collector
      env:
        ALL_PROXY: socks5://127.0.0.1:40000
        FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
        GIT_EMAIL: ${{ secrets.GIT_EMAIL || 'action@github.com' }}
        GIT_NAME: ${{ secrets.GIT_NAME || 'GitHub Action' }}
        http_proxy: socks5://127.0.0.1:40000
        https_proxy: socks5://127.0.0.1:40000
      run: |
        echo "å¼€å§‹èŠ‚ç‚¹æ”¶é›†..."
        echo "ä»£ç†è®¾ç½®ï¼š"
        echo "  http_proxy=$http_proxy"
        echo "  https_proxy=$https_proxy"
        echo "  ALL_PROXY=$ALL_PROXY"
        python3 src/main.py --update-github
        echo "èŠ‚ç‚¹æ”¶é›†å®Œæˆ"
      continue-on-error: true
    
    - name: Check for collection changes
      id: collection_changes
      run: |
        echo "æ£€æŸ¥æ”¶é›†å®Œæˆçš„æ–‡ä»¶çŠ¶æ€..."
        echo "å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        echo ""
        echo "result ç›®å½•å†…å®¹:"
        ls -la result/ || echo "result ç›®å½•ä¸å­˜åœ¨"
        echo ""
        
        # æ£€æŸ¥nodetotal.txtæ˜¯å¦å­˜åœ¨
        if [ -f result/nodetotal.txt ]; then
          echo "result/nodetotal.txt å­˜åœ¨"
          total_count=$(wc -l < result/nodetotal.txt)
          echo "æ€»èŠ‚ç‚¹æ•°: $total_count"
          
          echo ""
          echo "Git çŠ¶æ€:"
          git status
          
          echo ""
          echo "æ£€æŸ¥nodetotal.txtå˜æ›´..."
          if git diff --quiet HEAD -- result/nodetotal.txt; then
            echo "has_nodetotal_changes=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ”¶é›†æ›´æ–°"
          else
            echo "has_nodetotal_changes=true" >> $GITHUB_OUTPUT
            echo "total_node_count=$total_count" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°æ”¶é›†æ›´æ–°ï¼Œéœ€è¦æäº¤nodetotal.txt"
          fi
        else
          echo "result/nodetotal.txt ä¸å­˜åœ¨"
          echo "has_nodetotal_changes=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit nodetotal.txt (collection complete)
      if: steps.collection_changes.outputs.has_nodetotal_changes == 'true'
      run: |
        git config --global user.email "${{ secrets.GIT_EMAIL || 'action@github.com' }}"
        git config --global user.name "${{ secrets.GIT_NAME || 'GitHub Action' }}"
        
        # åªæäº¤nodetotal.txt
        git add result/nodetotal.txt
        
        total_count="${{ steps.collection_changes.outputs.total_node_count }}"
        commit_msg="Collect nodes - $(date '+%Y-%m-%d %H:%M:%S') ($total_count total nodes)"
        
        git commit -m "$commit_msg"
        git push
        
        echo "æ”¶é›†èŠ‚ç‚¹å·²æäº¤å¹¶æ¨é€åˆ°ä»“åº“"
    
    - name: Trigger Karing latency test
      if: steps.collection_changes.outputs.has_nodetotal_changes == 'true'
      run: |
        echo "ğŸš€ è§¦å‘Karingå»¶è¿Ÿæµ‹è¯•..."
        
        # è·å–å½“å‰æäº¤SHA
        current_sha=$(git rev-parse HEAD)
        total_count="${{ steps.collection_changes.outputs.total_node_count }}"
        
        echo "å½“å‰æäº¤: $current_sha"
        echo "æ€»èŠ‚ç‚¹æ•°: $total_count"
        
        # ä½¿ç”¨gh CLIè§¦å‘karingæµ‹é€Ÿworkflow
        gh workflow run test_nodes_karing.yml \
          --ref main \
          -f trigger_collection=true \
          -f collection_commit="$current_sha" \
          -f total_nodes="$total_count"
        
        echo "âœ… Karingå»¶è¿Ÿæµ‹è¯•å·²è§¦å‘"
    
    - name: Create summary (collection)
      if: always()
      run: |
        echo "## ğŸ“¦ èŠ‚ç‚¹æ”¶é›†æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "- **è¿è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.collection_changes.outputs.has_nodetotal_changes }}" == "true" ]; then
          echo "- **æ›´æ–°çŠ¶æ€**: âœ… æˆåŠŸæ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€»èŠ‚ç‚¹æ•°**: ${{ steps.collection_changes.outputs.total_node_count }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **æ›´æ–°çŠ¶æ€**: â„¹ï¸ æ— æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.collector.outcome }}" != "success" ]; then
          echo "- **æ”¶é›†çŠ¶æ€**: âš ï¸ æ”¶é›†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.collector.outcome }}" != "success" ]; then
          echo "- **æ”¶é›†çŠ¶æ€**: âš ï¸ æ”¶é›†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯" >> $GITHUB_STEP_SUMMARY
          echo "- **åç»­åŠ¨ä½œ**: âŒ ä¸ä¼šè§¦å‘æµ‹é€Ÿ" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -f result/nodetotal.txt ]; then
          total_count=$(wc -l < result/nodetotal.txt)
          echo "- **æ€»èŠ‚ç‚¹æ•°**: $total_count" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ èŠ‚ç‚¹æ›´æ–°å¤±è´¥"
        echo "è¯·æ£€æŸ¥æ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯"
        exit 1