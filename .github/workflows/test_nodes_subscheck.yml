name: Test Nodes with Subscheck

on:
  schedule:
    # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡æµ‹é€Ÿ (åŒ—äº¬æ—¶é—´ 0:00, 12:00)
    - cron: '0 */12 * * *'
  
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      trigger_collection:
        description: 'æ˜¯å¦ç”±æ”¶é›†å·¥ä½œæµè§¦å‘'
        required: false
        default: false
        type: boolean
      collection_commit:
        description: 'æ”¶é›†å·¥ä½œæµçš„æäº¤SHA'
        required: false
        default: ''
        type: string
      total_nodes:
        description: 'æ”¶é›†åˆ°çš„æ€»èŠ‚ç‚¹æ•°'
        required: false
        default: '0'
        type: string
  
  workflow_run:
    workflows: ["Update Free Nodes"]
    types:
      - completed
    branches: [main]

jobs:
  test-nodes:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2å°æ—¶è¶…æ—¶ï¼Œç»™12å°æ—¶è¿è¡Œå……è¶³æ—¶é—´
    permissions:
      contents: write
    
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        persist-credentials: true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r config/requirements.txt
    
    - name: Install Cloudflare WARP
      run: |
        # æ·»åŠ  Cloudflare GPG å¯†é’¥
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
        
        # æ·»åŠ  Cloudflare ä»“åº“
        echo 'deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ jammy main' | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
        
        # æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£… warp-cli
        sudo apt-get update
        sudo apt-get install -y cloudflare-warp
    
    - name: Connect to Cloudflare WARP
      run: |
        # å¯åŠ¨ WARP æœåŠ¡
        sudo systemctl enable --now warp-svc

        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 10

        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        sudo systemctl status warp-svc --no-pager || true

        # æ³¨å†Œ WARPï¼ˆä½¿ç”¨åŒ¿åæ¨¡å¼ï¼‰
        warp-cli --accept-tos registration new

        # è®¾ç½® WARP ä»£ç†æ¨¡å¼ï¼ˆå…³é”®æ­¥éª¤ï¼‰
        echo "è®¾ç½®WARPä¸ºä»£ç†æ¨¡å¼..."
        warp-cli --accept-tos mode proxy 2>/dev/null || warp-cli --accept-tos set-mode proxy 2>/dev/null || true

        # è®¾ç½® SOCKS5 ä»£ç†ç«¯å£
        echo "è®¾ç½®SOCKS5ä»£ç†ç«¯å£40000..."
        warp-cli --accept-tos proxy port 40000 2>/dev/null || warp-cli --accept-tos set-proxy-port 40000 2>/dev/null || true

        # è¿æ¥ WARP
        warp-cli --accept-tos connect

        # ç­‰å¾…è¿æ¥å®Œå…¨å»ºç«‹
        echo "â³ ç­‰å¾…WARPè¿æ¥å®Œå…¨å»ºç«‹..."
        sleep 20

        # éªŒè¯è¿æ¥çŠ¶æ€
        echo "ğŸ” æ£€æŸ¥WARPè¿æ¥çŠ¶æ€..."
        warp-cli --accept-tos status

        # éªŒè¯SOCKS5ä»£ç†ç«¯å£
        echo "ğŸ” æ£€æŸ¥SOCKS5ä»£ç†ç«¯å£40000..."
        if sudo ss -tlnp | grep -q ":40000"; then
          echo "âœ“ SOCKS5ä»£ç†ç«¯å£40000å·²ç›‘å¬"
        else
          echo "âš ï¸ SOCKS5ä»£ç†ç«¯å£40000æœªç›‘å¬"
        fi

        # éªŒè¯IPå˜æ›´
        echo "ğŸŒ éªŒè¯IPåœ°å€å˜æ›´..."
        current_ip=$(curl -s --max-time 10 ipinfo.io/ip || echo "æ£€æµ‹å¤±è´¥")
        echo "å½“å‰IP: $current_ip"

        # è·å– WARP ä»£ç†ç«¯å£ï¼ˆé€šå¸¸æ˜¯ 40000ï¼‰
        echo "âœ… WARP ä»£ç†å·²å¯ç”¨ï¼ŒSOCKS5 ç«¯å£: 40000"
    
    - name: Cache subs-check binary
      id: cache-subscheck
      uses: actions/cache@v4
      with:
        path: tools/subscheck/bin/subs-check
        key: subs-check-${{ runner.os }}-${{ runner.arch }}-v2-${{ github.run_id }}
        restore-keys: |
          subs-check-${{ runner.os }}-${{ runner.arch }}-v2-
          subs-check-${{ runner.os }}-${{ runner.arch }}-
          subs-check-${{ runner.os }}-
    
    - name: Install subs-check
      if: steps.cache-subscheck.outputs.cache-hit != 'true'
      run: |
        echo "å®‰è£…subs-checkå·¥å…·..."
        chmod +x src/utils/convert_nodes_to_subscription.py
        chmod +x src/speedtest/test_nodes_with_subscheck.py
        
        # æ‰‹åŠ¨ä¸‹è½½subs-check
        mkdir -p tools/subscheck/bin
        cd tools/subscheck/bin
        
        wget -q --timeout=300 --tries=3 https://github.com/beck-8/subs-check/releases/latest/download/subs-check_Linux_x86_64.tar.gz -O subs-check.tar.gz
        tar -xzf subs-check.tar.gz
        chmod +x subs-check
        rm -f subs-check.tar.gz
        
        echo "âœ… subs-checkå®‰è£…å®Œæˆ"
    
    - name: Test nodes with subs-check
      id: tester
      run: |
        echo "ğŸš€ å¼€å§‹èŠ‚ç‚¹æµ‹è¯• - 12å°æ—¶å®šæ—¶ç­–ç•¥"
        echo "ğŸ“Š Configuration:"
        echo "  â° Schedule: Every 12 hours (00:00, 12:00 Beijing Time)"
        echo "  ğŸ”§ Phase 1: Connectivity test (concurrent=8, timeout=4s, silent=60s)"
        echo "  ğŸ”§ Phase 2: Media detection (concurrent=5, timeout=10s, silent=120s)"
        echo "  ğŸ¯ Filter: GPT or Gemini at least 1 pass (2é€‰1)"
        echo "  ğŸ“ Strategy: Based on SubsCheck-Win-GUI standards"

        # æ£€æŸ¥èŠ‚ç‚¹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
        if [ ! -f result/nodetotal.txt ] || [ ! -s result/nodetotal.txt ]; then
          echo "âŒ No valid nodes file found (result/nodetotal.txt is missing or empty)"
          echo "âš ï¸ Skipping node testing as there are no nodes to test"
          exit 0
        fi

        # è·å–èŠ‚ç‚¹æ•°
        total_nodes=$(wc -l < result/nodetotal.txt)
        echo "ğŸ“ˆ Total nodes to test: $total_nodes"

        # ä½¿ç”¨ä¸¤é˜¶æ®µæµ‹è¯•è„šæœ¬ - æ·»åŠ å®æ—¶è¿›åº¦è¾“å‡º
        set -e
        echo "ğŸ”„ Starting Python test script with progress indicators..."
        echo "ğŸ“ Processing nodes with enhanced feedback..."
        
        # Pythonè¯­æ³•æ£€æŸ¥
        echo "ğŸ” Python syntax check..."
        python3 -m py_compile src/speedtest/test_nodes_with_subscheck.py
        echo "âœ… Python syntax check passed"

        echo "ğŸš€ Executing Python script..."
        echo "ğŸ”— Command: python3 src/speedtest/test_nodes_with_subscheck.py --input result/nodetotal.txt --output result/nodelist.txt"
        echo "â³ Starting test with progress monitoring..."
        echo ""
        echo "âš¡ å¼€å§‹æ‰§è¡ŒèŠ‚ç‚¹æµ‹é€Ÿ..."
        python3 src/speedtest/test_nodes_with_subscheck.py --input result/nodetotal.txt --output result/nodelist.txt
        
        echo ""
        echo "ğŸ“Š Pythonè„šæœ¬æ‰§è¡Œå®Œæˆï¼"

        echo "èŠ‚ç‚¹æµ‹è¯•å®Œæˆ"
      continue-on-error: true
    
    - name: Check for changes
      id: changes
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶çŠ¶æ€..."
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f result/nodelist.txt ]; then
          echo "result/nodelist.txt å­˜åœ¨"
          node_count=$(wc -l < result/nodelist.txt)
          echo "æœ‰æ•ˆèŠ‚ç‚¹æ•°: $node_count"
          echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -5 result/nodelist.txt || echo "æ— æ³•é¢„è§ˆ"
        else
          echo "result/nodelist.txt ä¸å­˜åœ¨"
          node_count=0
        fi
        
        echo ""
        echo "Git çŠ¶æ€:"
        git status
        
        echo ""
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        if git diff --quiet HEAD -- result/nodelist.txt; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°èŠ‚ç‚¹æ›´æ–°"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°èŠ‚ç‚¹æ›´æ–°"
          echo "å˜æ›´è¯¦æƒ…:"
          git diff HEAD -- result/nodelist.txt || echo "æ— æ³•æ˜¾ç¤ºå˜æ›´"
        fi
    
    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        # å…ˆæ‹‰å–æœ€æ–°ä»£ç é¿å…å†²çª
        git pull origin main --rebase || true
        
        # æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº
        git add result/nodelist.txt
        
        # è·å–èŠ‚ç‚¹æ•°é‡ç”¨äºæäº¤ä¿¡æ¯
        if [ -f result/nodelist.txt ]; then
          valid_count=$(wc -l < result/nodelist.txt)
        else
          valid_count=0
        fi
        
        if [ -f result/nodetotal.txt ]; then
          total_count=$(wc -l < result/nodetotal.txt)
        else
          total_count=0
        fi
        
        # ç”Ÿæˆè¯¦ç»†çš„æäº¤ä¿¡æ¯
        if [ ${total_count} -gt 0 ]; then
          pass_rate=$(echo "scale=1; ${valid_count} * 100 / ${total_count}" | bc -l)
          git commit -m "èŠ‚ç‚¹æµ‹è¯• - èŠ‚ç‚¹æ€»æ•°:${total_count} æœ‰æ•ˆèŠ‚ç‚¹:${valid_count} é€šè¿‡ç‡:${pass_rate}%"
        else
          git commit -m "èŠ‚ç‚¹æµ‹è¯• - èŠ‚ç‚¹æ€»æ•°:${total_count} æœ‰æ•ˆèŠ‚ç‚¹:${valid_count} é€šè¿‡ç‡:N/A"
        fi
        
        # å°è¯•æ¨é€ï¼Œå¦‚æœæœ‰å†²çªåˆ™é‡è¯•
        for i in {1..3}; do
          if git push origin main; then
            echo "âœ… æˆåŠŸæ¨é€åˆ°è¿œç¨‹ä»“åº“"
            break
          elif [ $i -eq 3 ]; then
            echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²é‡è¯•3æ¬¡"
            exit 1
          else
            echo "âš ï¸ ç¬¬$iæ¬¡æ¨é€å¤±è´¥ï¼Œç­‰å¾…5ç§’åé‡è¯•..."
            sleep 5
          fi
        done
        
        echo "æµ‹é€Ÿç»“æœå·²æäº¤å¹¶æ¨é€åˆ°ä»“åº“"
    
    - name: Create summary
      if: always()
      run: |
        echo "## èŠ‚ç‚¹æµ‹é€Ÿæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "- **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        
        # åˆ¤æ–­è§¦å‘æ¥æº
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.trigger_collection }}" == "true" ]; then
          echo "- **è§¦å‘æ–¹å¼**: ğŸ“¦ æ”¶é›†å·¥ä½œæµè§¦å‘" >> $GITHUB_STEP_SUMMARY
          echo "- **æ”¶é›†æäº¤**: ${{ github.event.inputs.collection_commit }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€»èŠ‚ç‚¹æ•°**: ${{ github.event.inputs.total_nodes }}" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ github.event_name }}" == "workflow_run" ]; then
          echo "- **è§¦å‘æ–¹å¼**: ğŸ”„ æ”¶é›†å·¥ä½œæµå®Œæˆè§¦å‘" >> $GITHUB_STEP_SUMMARY
          echo "- **æ”¶é›†å·¥ä½œæµ**: ${{ github.event.workflow_run.id }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **è§¦å‘æ–¹å¼**: â° å®šæ—¶è§¦å‘" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
          echo "- **æ›´æ–°çŠ¶æ€**: âœ… æˆåŠŸæ›´æ–°" >> $GITHUB_STEP_SUMMARY
          if [ -f result/nodelist.txt ]; then
            valid_count=$(wc -l < result/nodelist.txt)
            echo "- **æœ‰æ•ˆèŠ‚ç‚¹æ•°**: $valid_count" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f result/nodetotal.txt ]; then
            total_count=$(wc -l < result/nodetotal.txt)
            echo "- **åŸå§‹èŠ‚ç‚¹æ•°**: $total_count" >> $GITHUB_STEP_SUMMARY
            if [ -f result/nodelist.txt ]; then
              success_rate=$(echo "scale=1; $valid_count * 100 / $total_count" | bc)
              echo "- **æˆåŠŸç‡**: $success_rate%" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æµ‹è¯•ç­–ç•¥**:" >> $GITHUB_STEP_SUMMARY
          echo "- ä½¿ç”¨subs-checkå·¥å…·è¿›è¡ŒçœŸå®çš„ä»£ç†æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- æµ‹è¯•èŠ‚ç‚¹è¿é€šæ€§ã€é€Ÿåº¦å’Œæµåª’ä½“è§£é”èƒ½åŠ›" >> $GITHUB_STEP_SUMMARY
          echo "- æ”¯æŒçš„æµåª’ä½“å¹³å°: YouTube, Netflix, OpenAI, Gemini" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **æ›´æ–°çŠ¶æ€**: â„¹ï¸ æ— æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.tester.outcome }}" != "success" ]; then
          echo "- **æµ‹é€ŸçŠ¶æ€**: âš ï¸ æµ‹é€Ÿè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ èŠ‚ç‚¹æµ‹é€Ÿå¤±è´¥"
        echo "è¯·æ£€æŸ¥æ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯"
        exit 1